<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Number Picker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.rawgit.com/HubSpot/odometer/master/themes/odometer-theme-default.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.rawgit.com/HubSpot/odometer/master/odometer.js"></script>
</head>

<body>
    <div class="accent-bar"></div>
    <button id="settings-btn" onclick="toggleSettings()"><i class="fas fa-gear"></i></button>
    <button id="fullscreen-btn" onclick="toggleFullscreen()"><i class="fas fa-expand"></i></button>
    <div class="settings-backdrop" id="backdrop" onclick="closeSettings()"></div>

    <div class="main-content">
        <h1 id="number">Nhấn nút!</h1>
        <button class="primary-btn" onclick="pickNumber()"><i class="fas fa-dice"></i> Chọn số</button>
    </div>

    <div class="controls-container">
        <div id="history"></div>
        <div class="controls">
            <button onclick="toggleAuto()"><i class="fas fa-play"></i> Tự động chọn</button>
            <div class="interval-controls">
                <button onclick="changeInterval(-1)">-</button>
                <span id="interval">3</span> giây
                <button onclick="changeInterval(1)">+</button>
            </div>
            <button class="reset-btn" onclick="reset()"><i class="fas fa-refresh"></i></button>
        </div>
    </div>

    <div id="settings">
        <div class="settings-header">
            <h3><i class="fas fa-sliders-h"></i> Cài đặt</h3>
            <button onclick="closeSettings()"><i class="fas fa-times"></i></button>
        </div>
        <div class="controls">
            <span><i class="fas fa-volume-up"></i> Pitch:</span>
            <button onclick="changePitch(-0.1)"><i class="fas fa-minus"></i></button>
            <span id="pitch">2.0</span>
            <button onclick="changePitch(0.1)"><i class="fas fa-plus"></i></button>
        </div>
        <div class="controls">
            <span><i class="fas fa-tachometer-alt"></i> Speed:</span>
            <button onclick="changeSpeed(-0.1)"><i class="fas fa-minus"></i></button>
            <span id="speed">1.2</span>
            <button onclick="changeSpeed(0.1)"><i class="fas fa-plus"></i></button>
        </div>
        <div class="controls">
            <button class="animation-toggle" onclick="toggleAnimation()" id="animation-btn">
                <i class="fas fa-magic"></i> Bật chuyển động
            </button>
        </div>
    </div>

    <script>
        let numbers = [...Array(90).keys()].map(n => n + 1);
        let history = [];
        let voice = null;
        let autoInterval = null;
        let intervalTime = 3;
        let pitch = 2;
        let speed = 1.2;
        let animationEnabled = true;
        let odometer = null;

        function saveSettings() {
            localStorage.setItem('settings', JSON.stringify({ pitch, speed, animationEnabled, intervalTime }));
        }

        function loadSettings() {
            const saved = localStorage.getItem('settings');
            if (saved) {
                const settings = JSON.parse(saved);
                pitch = settings.pitch || 2;
                speed = settings.speed || 1.2;
                animationEnabled = settings.animationEnabled !== false;
                intervalTime = settings.intervalTime || 3;

                document.getElementById("pitch").textContent = pitch.toFixed(1);
                document.getElementById("speed").textContent = speed.toFixed(1);
                document.getElementById("interval").textContent = intervalTime;

                const btn = document.getElementById('animation-btn');
                btn.innerHTML = animationEnabled ? '<i class="fas fa-magic"></i> Tắt chuyển động' : '<i class="fas fa-magic"></i> Bật chuyển động';
                btn.classList.toggle('active', animationEnabled);
            }
        }

        function loadVoices() {
            voice = speechSynthesis.getVoices().find(v => v.lang === 'vi-VN');
        }

        speechSynthesis.onvoiceschanged = loadVoices;

        function initOdometer() {
            const container = document.querySelector('.main-content');
            const current = document.getElementById('number');

            if (animationEnabled && !odometer && current.textContent !== "Nhấn nút!") {
                const currentValue = current.textContent === "Hết số rồi!" ? 0 : (parseInt(current.textContent) || 0);
                const newEl = document.createElement('h1');
                newEl.id = 'number';
                newEl.classList.add('odometer');
                newEl.textContent = currentValue;
                container.replaceChild(newEl, current);
                odometer = new Odometer({ el: newEl, value: currentValue });
            } else if (!animationEnabled && odometer) {
                const newEl = document.createElement('h1');
                newEl.id = 'number';
                newEl.textContent = current.textContent === "Hết số rồi!" ? "Hết số rồi!" : (history.length > 0 ? history[history.length - 1] : "Nhấn nút!");
                newEl.style.animation = 'textFadeIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                container.replaceChild(newEl, current);
                odometer = null;
                setTimeout(() => newEl.style.animation = '', 400);
            }
        }

        function toggleAnimation() {
            animationEnabled = !animationEnabled;
            const btn = document.getElementById('animation-btn');
            btn.innerHTML = animationEnabled ? '<i class="fas fa-magic"></i> Tắt chuyển động' : '<i class="fas fa-magic"></i> Bật chuyển động';
            btn.classList.toggle('active', animationEnabled);
            initOdometer();
            saveSettings();
        }

        function pickNumber() {
            if (numbers.length === 0) {
                document.getElementById("number").textContent = "Hết số rồi!";
                return;
            }

            const chosen = numbers.splice(Math.floor(Math.random() * numbers.length), 1)[0];
            history.push(chosen);

            const numberEl = document.getElementById('number');

            if (animationEnabled) {
                if (!odometer) {
                    const container = document.querySelector('.main-content');
                    const newEl = document.createElement('h1');
                    newEl.id = 'number';
                    newEl.classList.add('odometer');
                    newEl.textContent = '0';
                    container.replaceChild(newEl, numberEl);
                    odometer = new Odometer({ el: newEl, value: 0 });
                    setTimeout(() => odometer.update(chosen), 50);
                } else {
                    odometer.update(chosen);
                }
            } else {
                numberEl.textContent = chosen;
                numberEl.style.animation = 'numberPulse 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)';
                setTimeout(() => numberEl.style.animation = '', 600);
            }

            const historyEl = document.getElementById("history");
            historyEl.classList.add('show');
            historyEl.textContent = `Lịch sử: ${history.join(', ')}`;

            const utterance = new SpeechSynthesisUtterance(chosen);
            utterance.lang = 'vi-VN';
            utterance.pitch = pitch;
            utterance.rate = speed;
            if (voice) utterance.voice = voice;
            speechSynthesis.speak(utterance);
        }

        function reset() {
            const autoBtn = document.querySelector('button[onclick="toggleAuto()"]');
            const primaryBtn = document.querySelector('.primary-btn');

            clearInterval(autoInterval);
            autoInterval = null;
            autoBtn.classList.remove('active');
            autoBtn.innerHTML = '<i class="fas fa-play"></i> Tự động chọn';

            document.body.classList.remove('presentation-mode');
            primaryBtn.classList.remove('hidden');

            numbers = [...Array(90).keys()].map(n => n + 1);
            history = [];

            const container = document.querySelector('.main-content');
            const newEl = document.createElement('h1');
            newEl.id = 'number';
            newEl.textContent = "Nhấn nút!";
            container.replaceChild(newEl, document.getElementById('number'));
            odometer = null;

            document.getElementById("history").classList.remove('show');
        }

        function toggleAuto() {
            const btn = document.querySelector('button[onclick="toggleAuto()"]');
            const primaryBtn = document.querySelector('.primary-btn');

            if (autoInterval) {
                clearInterval(autoInterval);
                autoInterval = null;
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-play"></i> Tự động chọn';
                document.body.classList.remove('presentation-mode');
                primaryBtn.classList.remove('hidden');
            } else {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-stop"></i> Dừng tự động';
                document.body.classList.add('presentation-mode');
                primaryBtn.classList.add('hidden');

                autoInterval = setInterval(() => {
                    if (numbers.length === 0) {
                        toggleAuto();
                    } else {
                        pickNumber();
                    }
                }, intervalTime * 1000);
            }
        }

        function changeInterval(amount) {
            intervalTime = Math.max(1, intervalTime + amount);
            document.getElementById("interval").textContent = intervalTime;
            saveSettings();
            if (autoInterval) {
                clearInterval(autoInterval);
                autoInterval = setInterval(() => {
                    if (numbers.length === 0) toggleAuto();
                    else pickNumber();
                }, intervalTime * 1000);
            }
        }

        function changePitch(amount) {
            pitch = Math.max(0, Math.min(2, pitch + amount));
            document.getElementById("pitch").textContent = pitch.toFixed(1);
            saveSettings();
        }

        function changeSpeed(amount) {
            speed = Math.max(0.5, Math.min(10, speed + amount));
            document.getElementById("speed").textContent = speed.toFixed(1);
            saveSettings();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function toggleSettings() {
            const settings = document.getElementById("settings");
            const backdrop = document.getElementById("backdrop");
            const btn = document.getElementById("settings-btn");

            if (settings.classList.contains('show')) {
                closeSettings();
            } else {
                backdrop.classList.add('show');
                setTimeout(() => settings.classList.add('show'), 100);
                btn.innerHTML = '<i class="fas fa-times"></i>';
                document.addEventListener('keydown', e => e.key === 'Escape' && closeSettings());
            }
        }

        function closeSettings() {
            const settings = document.getElementById("settings");
            const backdrop = document.getElementById("backdrop");
            const btn = document.getElementById("settings-btn");

            settings.classList.remove('show');
            setTimeout(() => backdrop.classList.remove('show'), 200);
            btn.innerHTML = '<i class="fas fa-cogs"></i>';
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadVoices();
            loadSettings();
            setTimeout(() => document.body.style.opacity = '1', 100);
        });
    </script>
</body>

</html>